@{
    ViewData["Title"] = "Role Management";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2>Role Management</h2>
            <p>Create, edit, and manage roles and their associated rights.</p>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-12">
            <button id="addRoleBtn" class="btn btn-success">Add New Role</button>
        </div>
    </div>

    <!-- Separator Line -->
    <hr class="my-4" style="border-top: 2px solid #dee2e6;">

    <!-- Roles Grid -->
    <div class="row">
        <div class="col-12">
            <div id="rolesGrid"></div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        /* Fix Kendo Grid sort icons */
        .k-grid-header .k-header .k-link .k-icon {
            font-size: 12px !important;
            width: 12px !important;
            height: 12px !important;
        }
        
        .k-grid-header .k-header .k-link .k-icon.k-i-sort-asc-sm,
        .k-grid-header .k-header .k-link .k-icon.k-i-sort-desc-sm {
            font-size: 12px !important;
            width: 12px !important;
            height: 12px !important;
        }
        
        /* Fix filter menu positioning */
        .k-filter-menu {
            z-index: 10000 !important;
        }
        
        /* Consistent header styling */
        .k-grid-header .k-header {
            font-weight: 600;
            background-color: #f8f9fa;
        }
    </style>
}

@section Scripts {
    <script>
        $(document).ready(function () {
            console.log("Initializing Roles Grid...");
            
            // Initialize Kendo Grid
            $("#rolesGrid").kendoGrid({
                dataSource: {
                    transport: {
                        read: {
                            url: "/Roles/GetRoles",
                            type: "GET",
                            dataType: "json"
                        }
                    },
                    schema: {
                        model: {
                            id: "id",
                            fields: {
                                id: { type: "number" },
                                name: { type: "string" },
                                description: { type: "string" },
                                isActive: { type: "boolean" },
                                createdDate: { type: "date" },
                                rightsCount: { type: "number" }
                            }
                        }
                    },
                    pageSize: 10
                },
                height: 500,
                sortable: true,
                filterable: {
                    mode: "row"
                },
                pageable: {
                    refresh: true,
                    pageSizes: [5, 10, 20, 50],
                    buttonCount: 5
                },
                columns: [
                    { field: "id", title: "ID", width: "80px" },
                    { field: "name", title: "Role Name", width: "200px" },
                    { field: "description", title: "Description", width: "300px" },
                    { field: "rightsCount", title: "Rights Count", width: "120px" },
                    { 
                        field: "isActive", 
                        title: "Active", 
                        width: "100px",
                        template: "#= isActive ? 'Yes' : 'No' #"
                    },
                    { 
                        field: "createdDate", 
                        title: "Created Date", 
                        width: "150px",
                        template: "#= kendo.toString(kendo.parseDate(createdDate), 'MM/dd/yyyy') #"
                    },
                    {
                        title: "Actions",
                        width: "200px",
                        template: "<button class='btn btn-sm btn-primary edit-role' data-id='#= id #'>Edit</button> " +
                                 "<button class='btn btn-sm btn-info manage-rights' data-id='#= id #'>Manage Rights</button>"
                    }
                ],
                dataBound: function(e) {
                    console.log("Roles Grid data bound. Records:", e.sender.dataSource.data().length);
                },
                error: function(e) {
                    console.error("Roles Grid error:", e);
                }
            });

            // Add new role
            $("#addRoleBtn").click(function () {
                var roleName = prompt("Enter role name:");
                if (roleName) {
                    var roleDescription = prompt("Enter role description:");
                    
                    $.ajax({
                        url: "/Roles/CreateRole",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify({
                            Name: roleName,
                            Description: roleDescription || ""
                        }),
                        success: function (response) {
                            if (response.success) {
                                alert("Role created successfully!");
                                $("#rolesGrid").data("kendoGrid").dataSource.read();
                            } else {
                                alert("Error: " + response.message);
                            }
                        },
                        error: function (xhr, status, error) {
                            alert("Error creating role: " + error);
                        }
                    });
                }
            });

            // Edit role
            $(document).on('click', '.edit-role', function () {
                var roleId = $(this).data('id');
                window.location.href = '/Roles/Edit/' + roleId;
            });

            // Manage rights
            $(document).on('click', '.manage-rights', function () {
                var roleId = $(this).data('id');
                // TODO: Open rights management modal
                alert("Rights management for role " + roleId + " will be implemented");
            });
        });
    </script>
}






